# 用户下单流程

## 后台时序图
```plantuml
@startuml
... 加购流程 ...
... 下单流程 ... 
APP -> shopping: shopping/cal_price/v4_4 订单摘要

alt 已登陆并且使用优惠券
    shopping -> shopping: 判断有可供消费的优惠券
    shopping -> shopping: 订单使用的优惠券
    shopping -> shopping: 判读用户优惠券 + 地区
else 未登陆并且使用优惠券
    shopping -> shopping: 判读用户优惠券 + 地区
end 

shopping -> pricectrl: 商城优惠调用MallDiscounts
shopping -> rebateSrv: 请求Wallet信息
shopping -> forex: 获取外汇信息
shopping -> shopping: calc_price

APP <- shopping: 订单摘要返回
APP <-> payment: payment/adyen/recurring_details 已支付卡列表

APP -> address: 获取地址列表address-api/addresses/list
opt 添加地址
APP -> address: 添加地址: address-api/upsert
end

APP -> shopping: 获取订单使用的优惠券shopping/user_coupons_for_order
opt 兑换优惠券
APP -> coupon: coupon/redeem
end 

APP -> shopping: 下单 shopping/cart/checkout/entries
shopping -> shopping: 地址合法性判断（黑名单等）
shopping -> shopping: 计算价格calc_price

shopping -> APP: 下单 成功

APP -> shopping: shopping/orders/{order_id}/pay_cm 
shopping -> APP: 返回支付方式

APP <-> payment: adyen卡支付payment/adyen/authorise
APP -> shopping: 支付通知shopping/orders/{order_id}/paid_from_client
shopping -> shopping: 移除购物车等

adyen --> payment_callbak: 支付成功通知
payment_callbak -> orders: 支付成功通知
orders -> shopping: 支付成功通知
shopping -> shopping: 修改状态
...

@enduml
```                   

## 订单状态图


## 重构方案
- 总体目标QPS达到1000

### 方案一
继续在python老代码上改动， 将不需要的服务调用全部移除

### 方案二
- 保留现有DB结构和kafka通信链路，使用golang重写目前在使用的几个接口
    - shopping/cal_price/v4_4 ---- 订单摘要
    - shopping/user_coupons_for_order -- 获取订单使用的优惠券
    - shopping/cart/checkout/entries -- 下单
    - shopping/orders/{order_id}/pay_cm ---获取支付方式
    - shopping/orders/{order_id}/paid_from_client  ----告诉后台支付成功
    - event/payment_notified_cm 支付成功事件处理
    - event/payment_failed_cm 支付失败事件处理
    - event/purchased 购买事件处理
    - event/refund_notified 退款处理
    - event/* 其他事件处理
    

### 方案三