# 平台退款
[toc]

## 1. 概述
- issue: https://gitlab.momoso.com/cm/demands/-/issues/659
- pb: 
- 背景: 老shopping服务退款逻辑无法找到记录文档，也没有人清晰退款的完整逻辑和规则。 在这个基础上无法和新履约系统对接，所以需要退款业务进行重组。

## 2. 解决问题
- 老shopping会退款失败，切无法定位（不清楚业务逻辑和场景处理）
- 对接新履约系统


## 3. 目标
 - 正常发起退款，即平台计算应退款金额，然后由财务人员（或其他业务人员）根据应退款金额的发起退款。
 - 强制发起退款，即财务人员（或其他业务人员）手动输入应退款金额， 然后根据应退款金额的发起退款

## 4. 目标边界
- 仅保证在用户订单需要退款时，可以正常的退款。
- 不用考虑退款数据对其他子系统(财务系统等)的兼容.
- 不用考虑APP退款金额和售价不一致兼容。如不一致，客户端给一个友情提示。

## 5. 设计方案
-  提供退款预览接口，退款前财务人员查看。
-  提过退款接口，真正执行退款。
    - 模式一： 直接退款，退款金额和退款校验都是系统内部实现。 调用方只需要传用户订单和退款商品，系统内部
    - 模式二： 预览退款，退款金额由调用方给出，后台执行计算逻辑，进行二次核算，成功则直接退款，并在结果中返回总退款金额及明细 
    - 模式三： 强制退款，退款金额由调用方给出，系统内部进行基本校验（是否超过订单金额），然后退款
-  配置退款调用IP白名单，来增加安全系数。
 
### 5.1. 相关规则
- 优惠券不退
- 退款金额精度，单位分，精度分（向下取整）
- 直接退款/预览退款处理逻辑，根据一个订单内是否有剩余商品未退，区分出下列两种场景
    - 非最后一次退款（有剩余商品未执行退款操作）
        - 退款金额计算公式: RA = （退货商品的售价+已退款商品的售价）/ 订单内所有商品售价和 *（订单实付金额-总运费金额）- 已退款的金额
        - 这类退款，运费不退，优惠分摊到每个商品上。
        - 同一个品，不通的请求场景，退款金额计算不一样
        - **处理盲区: 一个单内同时出现了优惠商品和非优惠商品时，这个时候退款金额的计算会不够精确。 如果客户将优惠商品全部退掉，非优惠商品将变向的享受优惠。**
        
    - 最后一次退款
        - 退款金额计算公式: RA = 订单实收金额 - 已退款的金额
        - **这样处理会导致，最后一次退款的金额会大于售价**
- 强制退款处理逻辑
    - 分摊公式 RA =（该商品ID售价+已计算退款商品ID售价）/该批次退款商品的售价和 * 总退款金额 - 已退款金额
    - 这个退款场景一般出现在售后补偿
- 金额校验规则
    - 根据以上公式计算出退款金额，然后和请求退款金额比较
    - 退款总金额小于等于订单总金额
- 退款0.01分特别处理，除不向第三方发起退款请求外，其他的流程都和正常退款流程一样

### 5.2. 退款时许图

```plantuml
== 退款预览 ==

ofs -> order2: 传入订单ID和需要需要退款的商品KLID
order2 -> order2 : 获取请求的每个品退款状态及金额
note left
根据5.1中的退款规则计算
end note
order2 -> ofs : 返回每个品的详细退款信息

opt 缓存计算结果
order2 --> redis: key = hash(根据请求参数)， ttl = 15s
end

== 退款执行 ==
ofs -> order2: 传入订单ID和需要需要退款的商品KLID及其他参数
order2 --> redis: 分布式锁

opt 获取计算结果
order2 --> redis: key = hash(根据请求参数)
end

alt 直接退款
    alt 没有命中缓存
    order2 -> order2: 计算退款金额
    end 
else 预览退款
    alt 没有命中缓存
    order2 -> order2: 计算退款金额
    end 
    order2 -> order2: 判断退款金额及退款商品是否正常
else 强制退款
    order2 -> order2: 计算每个商品分摊金额
end

order2 -> order2: 判断退款总金额是否超过订单金额
order2 -> order2: 落库退款中
alt 退款金额0.01
order2 -> order2: 落库退款成功
else
order2 -> payment: 执行退款请求 
end

```


## Q&A
- Q: 
  A:
  
  
  
  
  


